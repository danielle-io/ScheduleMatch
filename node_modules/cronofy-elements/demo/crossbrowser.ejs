<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Embedding demo: integration checks</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.26/moment-timezone-with-data-10-year-range.js"></script>
    <link href="/demo/demo-styles.css" rel="stylesheet">
</head>
<body class="trouble">
    
    <% var slug = 'crossbrowser'; %>
    <%- include nav.ejs %>

    <h1>Cross browser compatibility</h1>

    <h2>Availability Viewer</h2>
    <div id="cronofy-availability-viewer"></div>
    <button id="cronofy-availability-query">New Query</button>
    
    <hr>
    
    <h2>Agenda View</h2>
    <div id="cronofy-agenda-view"></div>
    
    <hr>
    
    <h2>Availability Rules</h2>
    <div id="cronofy-availability-rules"></div>
    
    <hr>
    
    <h2>Slot Picker</h2>
    <div id="cronofy-slot-picker"></div>
    
    <hr>
    
    <h2>Calendar Sync</h2>
    <div id="cronofy-calendar-sync"></div>

    <script src="../build/CronofyElements.dev.ie.js"></script>

    <script>
        console.log('loading elements...');

        // Math.sign polyfill
        if (!Math.sign) {
            Math.sign = function(x) {
              return ((x > 0) - (x < 0)) || +x;
            };
        }

        const sniffedTimezone = moment.tz.guess();

        const utcOffset = moment().tz(sniffedTimezone).utcOffset();
        const invertedOffset =
            Math.sign(utcOffset) === -1 ? Math.abs(utcOffset) : 0 - utcOffset;
        const offset = invertedOffset / 60;

        const today = moment()
            .tz(sniffedTimezone)
            .add(1, "day")
            .seconds(0);
        const startDay = today
            .startOf('isoWeek')
            .subtract(1, "day")
            .add(7,"day");

        const offsetTime = function(days, time) {
            const timeString = startDay.clone().format("YYYY-MM-DD") + 'T' + time + ':00Z';
            const output = moment(timeString)
                .add(days, "days")
                .add(offset, "hours");
            return output.utc().format();
        };
        
        const Viewer = CronofyElements.AvailabilityViewer({
            element_token: "<%= availability_token %>",
            target_id: 'cronofy-availability-viewer',
            api_domain:"<%= api_domain %>",
            availability_query: {
                participants: [
                    {
                        required: "all",
                        members: [
                            { sub: "<%= sub %>" }
                        ]
                    }
                ],
                required_duration: { minutes: 60 },
                available_periods: [
                    { start: offsetTime(1, "09:00"), end: offsetTime(1, "17:30") },
                    { start: offsetTime(2, "08:00"), end: offsetTime(2, "17:30") },
                    { start: offsetTime(3, "09:00"), end: offsetTime(3, "17:30") },
                    { start: offsetTime(4, "09:00"), end: offsetTime(4, "17:30") },
                    { start: offsetTime(5, "09:00"), end: offsetTime(5, "17:30") },
                    { start: offsetTime(8, "09:00"), end: offsetTime(8, "17:30") },
                    { start: offsetTime(9, "09:00"), end: offsetTime(9, "17:30") },
                    { start: offsetTime(10, "09:00"), end: offsetTime(10, "17:30") },
                    { start: offsetTime(11, "09:00"), end: offsetTime(11, "17:30") },
                    { start: offsetTime(12, "09:00"), end: offsetTime(12, "17:30") }
                ],
            },
            config: {
                start_time:"08:00",
                end_time: "18:00",
                interval: 30,
                mode: "multi_select", // default | multi_select | no_confirm
            },
            styles: {
                prefix: "AV1"
            },
            callback: function(slot){console.log('callback',slot)},
            // locale: locale,
            // demo: true
        });

        const newQuery = document.querySelector('#cronofy-availability-query');
        newQuery.addEventListener('click',loadNewQuery,false);

        function loadNewQuery() {
            const newConfig = {
                start_time: '0' + Math.ceil(Math.random() * (9 - 7) + 7) + ':' + Math.ceil(Math.random() * (3 - 0) + 0) + '0',
                end_time: Math.ceil(Math.random() * (18 - 15) + 15)+':'+Math.ceil(Math.random() * (5 - 0) + 0) + '0',
                interval: 15
            };

            console.log(newConfig);
            Viewer.update({
                config: newConfig
            });
        }

        CronofyElements.Agenda({
            element_token: "<%= agenda_token %>",
            target_id: 'cronofy-agenda-view',
            api_domain:"<%= api_domain %>",
            demo: true,
            styles: {
                prefix:"AG1"
            }
        });

        CronofyElements.AvailabilityRules({
            element_token: "<%= rules_token %>",
            target_id: 'cronofy-availability-rules',
            api_domain:"<%= api_domain %>",
            availability_rule_id: "work_hours",
            tzid: "Etc/UTC",
            config: {
                start_time:"08:00",
                end_time: "18:00",
                duration: 15
            },
            styles: {
                prefix: "AR1",
            },
            demo: true
        });

        const slotTimes = function(days, time) {
            const timeString = moment().utc().format("YYYY-MM-DD") + 'T' + time + ':00Z';
            const output = moment(timeString)
                .add(days, "days");
            return output.utc().format();
        };

        CronofyElements.SlotPicker({
            element_token: "<%= slot_picker_token %>",
            target_id: 'cronofy-slot-picker',
            api_domain:"<%= api_domain %>",
            availability_query: {
                participants: [
                    {
                        required: "all",
                        members: [
                            { sub: "<%= sub %>" }
                        ]
                    }
                ],
                required_duration: { minutes: 30 },
                available_periods: [
                    { start: slotTimes(1,"07:00"), end: slotTimes(1,"12:00") },
                    { start: slotTimes(2,"09:00"), end: slotTimes(2,"13:00") },
                    { start: slotTimes(2,"14:00"), end: slotTimes(2,"17:00") },
                    { start: slotTimes(3,"09:00"), end: slotTimes(3,"13:00") },
                    { start: slotTimes(3,"14:00"), end: slotTimes(3,"17:00") }
                ]
            },
            styles: {
                prefix: "SP1"
            },
            callback: function(slot){console.log('callback',slot)},
            // locale: locale,
            // demo: true
        });

        CronofyElements.CalendarSync({
            element_token: "<%= cal_sync_token %>",
            target_id: 'cronofy-calendar-sync',
            app_domain:"<%= app_domain %>",
            api_domain:"<%= api_domain %>",
            data_center: "us",
            // authorization_url: "http://localhost:8080/auth/cronofy",
            // authorization_url: "/auth/cronofy",
            authorization: {
                redirect_uri: "http://localhost:8080/",
                client_id: "<%= client_id %>",
                scope: "read_only"
            },
            tzid: "Etc/UTC",
            demo: false,
            callback: function(cb){
                console.log("callback", cb);
            }
        });

        console.log('done.');
    </script>

</body>
</html>
