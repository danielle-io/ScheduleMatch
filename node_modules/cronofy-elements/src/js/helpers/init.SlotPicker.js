import moment from "moment-timezone";
import {
    parseToken,
    parseTarget,
    parseQuery,
    parseConnectionDomains,
    parseTranslations
} from "./init";
import { logConstructor } from "./logging";

export const parseSlotPickerOptions = (options = {}) => {
    const config = typeof options.config === "undefined" ? {} : options.config;
    const mode = typeof config.mode === "undefined" ? "confirm" : config.mode;
    const logs = typeof config.logs === "undefined" ? "warn" : config.logs;
    const log = logConstructor(logs, "Slot Picker", options.callback);

    const demoMode = typeof options.demo === "undefined" ? false : options.demo;
    if (demoMode) {
        log.warn("You are running in demo mode. No API requests will be made");
    }

    const token = parseToken(options, "slot-picker", log);
    if (!token && !demoMode) {
        log.error(
            "You need to include an `element_token`. If you're just testing (and don't want to use real API data) you can set the `demo` option to `true` to bypass the API connection and view dummy content."
        );
        return false;
    }

    const target = parseTarget(options, "slot-picker", log);

    const query = parseQuery(options, "slot-picker", log);

    if (typeof options.tzid === "undefined") {
        const sniffedTimezone = moment.tz.guess();
        options.tzid = sniffedTimezone;
        options.customtzid = false;
    } else {
        options.customtzid = true;
    }

    const domains = parseConnectionDomains(
        options.data_center,
        options.api_domain,
        options.app_domain
    );

    const translations = parseTranslations(
        options.translations,
        "availability_rules"
    );

    delete options.availability_query;
    delete options.element_token;
    delete options.target_id;
    delete options.translations;

    return {
        ...options,
        target,
        token,
        domains,
        query,
        config: { ...config, mode, logs },
        translations
    };
};
